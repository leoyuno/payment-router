<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zenith Gaming - Payment Router Dashboard</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#1a1a2e;--card:#16213e;--card-hover:#1a2744;--accent:#0f3460;
    --green:#00d4aa;--yellow:#f9c74f;--red:#f94144;--orange:#ff8c42;
    --text:#e0e0e0;--text-dim:#8892a4;--text-bright:#ffffff;
    --border:#253554;--input-bg:#0d1b33;--radius:12px;--shadow:0 4px 24px rgba(0,0,0,0.3);
  }
  body{
    font-family:-apple-system,system-ui,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
    background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:40px;
  }

  /* Header */
  .header{
    background:linear-gradient(135deg,#0f3460 0%,#16213e 50%,#1a1a2e 100%);
    padding:28px 40px;border-bottom:1px solid var(--border);
    display:flex;align-items:center;justify-content:space-between;
  }
  .header-left{display:flex;align-items:center;gap:16px}
  .header-logo{
    width:44px;height:44px;border-radius:10px;
    background:linear-gradient(135deg,var(--green),#0f3460);
    display:flex;align-items:center;justify-content:center;
    font-size:20px;font-weight:800;color:#fff;
  }
  .header h1{font-size:22px;color:var(--text-bright);font-weight:700;letter-spacing:-0.3px}
  .header p{font-size:13px;color:var(--text-dim);margin-top:2px}
  .header-status{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-dim)}
  .pulse{
    width:8px;height:8px;border-radius:50%;background:var(--green);
    animation:pulse 2s ease-in-out infinite;
  }
  @keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,212,170,0.4)}50%{opacity:.7;box-shadow:0 0 0 6px rgba(0,212,170,0)}}

  /* Layout */
  .container{max-width:1440px;margin:0 auto;padding:24px 32px}
  .section-title{font-size:14px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:16px}

  /* Processor Cards */
  .processors-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:32px}
  .proc-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:24px;transition:all .3s ease;position:relative;overflow:hidden;
  }
  .proc-card:hover{background:var(--card-hover);border-color:#2d4a6f}
  .proc-card::before{
    content:'';position:absolute;top:0;left:0;right:0;height:3px;
    transition:background .4s ease;
  }
  .proc-card[data-status="HEALTHY"]::before{background:var(--green)}
  .proc-card[data-status="DEGRADED"]::before{background:var(--yellow)}
  .proc-card[data-status="DOWN"]::before{background:var(--red)}

  .proc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .proc-name{font-size:17px;font-weight:700;color:var(--text-bright)}
  .proc-badges{display:flex;gap:6px;align-items:center}
  .badge{
    font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;
    text-transform:uppercase;letter-spacing:.5px;
  }
  .badge-healthy{background:rgba(0,212,170,0.15);color:var(--green)}
  .badge-degraded{background:rgba(249,199,79,0.15);color:var(--yellow)}
  .badge-down{background:rgba(249,65,68,0.15);color:var(--red)}
  .badge-circuit{
    font-size:10px;padding:2px 8px;border-radius:12px;
    background:rgba(255,255,255,0.06);color:var(--text-dim);
  }
  .badge-circuit.open{background:rgba(249,65,68,0.12);color:var(--red)}
  .badge-circuit.half-open{background:rgba(249,199,79,0.12);color:var(--yellow)}

  .proc-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
  .metric{text-align:center;padding:10px 4px;background:rgba(0,0,0,0.2);border-radius:8px}
  .metric-value{font-size:20px;font-weight:700;color:var(--text-bright)}
  .metric-label{font-size:11px;color:var(--text-dim);margin-top:2px}

  .proc-config{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;align-items:center}
  .config-tag{
    font-size:11px;padding:3px 8px;border-radius:6px;
    background:rgba(15,52,96,0.6);color:var(--text-dim);border:1px solid var(--border);
  }
  .geo-tag{background:rgba(0,212,170,0.08);color:var(--green);border-color:rgba(0,212,170,0.2)}

  .proc-stats{
    display:grid;grid-template-columns:repeat(3,1fr);gap:8px;
    margin-bottom:16px;padding-top:12px;border-top:1px solid var(--border);
  }
  .stat{text-align:center}
  .stat-value{font-size:14px;font-weight:600;color:var(--text-bright)}
  .stat-label{font-size:10px;color:var(--text-dim);margin-top:1px}
  .stat-approved .stat-value{color:var(--green)}
  .stat-declined .stat-value{color:var(--orange)}
  .stat-errors .stat-value{color:var(--red)}

  .proc-sim{padding-top:14px;border-top:1px solid var(--border)}
  .sim-label{font-size:11px;font-weight:600;color:var(--text-dim);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
  .sim-row{display:flex;gap:6px;flex-wrap:wrap}
  .sim-select{
    flex:1;min-width:120px;padding:7px 10px;border-radius:8px;border:1px solid var(--border);
    background:var(--input-bg);color:var(--text);font-size:12px;cursor:pointer;
    appearance:auto;
  }
  .sim-select:focus{outline:none;border-color:var(--green)}

  .btn-sm{
    padding:7px 12px;border-radius:8px;border:1px solid var(--border);
    background:var(--input-bg);color:var(--text);font-size:11px;font-weight:600;
    cursor:pointer;transition:all .2s ease;white-space:nowrap;
  }
  .btn-sm:hover{background:#1a2744;border-color:#3a5a8a}
  .btn-down{border-color:rgba(249,65,68,0.3);color:var(--red)}
  .btn-down:hover{background:rgba(249,65,68,0.1)}
  .btn-up{border-color:rgba(0,212,170,0.3);color:var(--green)}
  .btn-up:hover{background:rgba(0,212,170,0.1)}
  .btn-reset{border-color:rgba(255,255,255,0.1);color:var(--text-dim)}
  .btn-reset:hover{background:rgba(255,255,255,0.05)}

  .sim-active-indicator{
    display:inline-block;font-size:10px;color:var(--yellow);margin-top:6px;
    animation:blink 1.2s ease-in-out infinite;
  }
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}

  /* Payment Form + Response */
  .bottom-grid{display:grid;grid-template-columns:400px 1fr;gap:24px;margin-bottom:32px}
  .form-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:24px;
  }
  .form-card .section-title{margin-bottom:20px}
  .form-group{margin-bottom:14px}
  .form-group label{display:block;font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:5px}
  .form-group input,.form-group select{
    width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);
    background:var(--input-bg);color:var(--text-bright);font-size:14px;
    transition:border-color .2s;
  }
  .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--green)}
  .form-group select{cursor:pointer;appearance:auto}

  .form-actions{display:flex;gap:10px;margin-top:20px}
  .btn-primary{
    flex:1;padding:12px 20px;border-radius:10px;border:none;
    background:linear-gradient(135deg,var(--green),#00a88a);
    color:#0d1b33;font-size:14px;font-weight:700;cursor:pointer;
    transition:all .2s ease;
  }
  .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,212,170,0.3)}
  .btn-primary:active{transform:translateY(0)}
  .btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
  .btn-secondary{
    padding:12px 16px;border-radius:10px;border:1px solid var(--border);
    background:var(--input-bg);color:var(--text);font-size:13px;font-weight:600;
    cursor:pointer;transition:all .2s ease;white-space:nowrap;
  }
  .btn-secondary:hover{background:#1a2744;border-color:#3a5a8a}
  .btn-secondary:disabled{opacity:.5;cursor:not-allowed}

  .response-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:24px;display:flex;flex-direction:column;
  }
  .response-card .section-title{margin-bottom:16px}
  .response-empty{
    flex:1;display:flex;align-items:center;justify-content:center;
    color:var(--text-dim);font-size:14px;
  }
  .response-content{flex:1}
  .resp-status-row{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  .resp-status-badge{
    font-size:14px;font-weight:700;padding:6px 16px;border-radius:8px;
  }
  .resp-approved{background:rgba(0,212,170,0.15);color:var(--green)}
  .resp-declined{background:rgba(255,140,66,0.15);color:var(--orange)}
  .resp-error{background:rgba(249,65,68,0.15);color:var(--red)}
  .resp-processor{font-size:15px;font-weight:600;color:var(--text-bright)}

  .resp-details{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .resp-detail{padding:10px;background:rgba(0,0,0,0.2);border-radius:8px}
  .resp-detail-label{font-size:11px;color:var(--text-dim);margin-bottom:2px}
  .resp-detail-value{font-size:13px;font-weight:600;color:var(--text-bright)}

  .burst-progress{margin-top:12px;font-size:12px;color:var(--text-dim)}
  .burst-bar{
    width:100%;height:4px;background:rgba(255,255,255,0.06);border-radius:2px;margin-top:6px;overflow:hidden;
  }
  .burst-bar-fill{height:100%;background:var(--green);border-radius:2px;transition:width .2s ease;width:0}

  /* Transaction Log */
  .txn-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:24px;overflow:hidden;
  }
  .txn-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .txn-count{font-size:12px;color:var(--text-dim)}
  .txn-table-wrap{overflow-x:auto}
  table{width:100%;border-collapse:collapse;font-size:13px}
  thead th{
    text-align:left;padding:10px 12px;font-size:11px;font-weight:600;
    color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;
    border-bottom:1px solid var(--border);background:rgba(0,0,0,0.15);
    position:sticky;top:0;
  }
  tbody td{
    padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.03);
    color:var(--text);white-space:nowrap;
  }
  tbody tr{transition:background .15s ease}
  tbody tr:hover{background:rgba(255,255,255,0.02)}
  tbody tr.new-row{animation:rowFlash .8s ease}
  @keyframes rowFlash{0%{background:rgba(0,212,170,0.08)}100%{background:transparent}}

  .txn-status{font-weight:600;font-size:12px;padding:3px 8px;border-radius:6px;display:inline-block}
  .txn-approved{background:rgba(0,212,170,0.12);color:var(--green)}
  .txn-declined{background:rgba(255,140,66,0.12);color:var(--orange)}
  .txn-error{background:rgba(249,65,68,0.12);color:var(--red)}

  .txn-id{font-family:'SF Mono',SFMono-Regular,Consolas,monospace;font-size:12px;color:var(--text-dim)}
  .txn-processor{font-weight:600;color:var(--text-bright)}
  .txn-amount{font-weight:600;color:var(--text-bright)}
  .txn-country{
    display:inline-flex;align-items:center;justify-content:center;
    width:28px;height:20px;border-radius:4px;font-size:10px;font-weight:700;
    background:rgba(15,52,96,0.6);color:var(--text-dim);border:1px solid var(--border);
  }
  .txn-reason{font-size:12px;color:var(--text-dim)}
  .txn-latency{font-size:12px;color:var(--text-dim)}

  .empty-table{text-align:center;padding:40px 20px;color:var(--text-dim);font-size:14px}

  /* Scrollbar */
  ::-webkit-scrollbar{width:6px;height:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
  ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.2)}

  /* Responsive */
  @media(max-width:1100px){
    .processors-grid{grid-template-columns:1fr 1fr}
    .bottom-grid{grid-template-columns:1fr}
  }
  @media(max-width:700px){
    .processors-grid{grid-template-columns:1fr}
    .container{padding:16px}
    .header{padding:20px 16px;flex-direction:column;gap:12px;align-items:flex-start}
  }

  /* Toast */
  .toast-container{position:fixed;top:20px;right:20px;z-index:1000;display:flex;flex-direction:column;gap:8px}
  .toast{
    padding:12px 20px;border-radius:10px;font-size:13px;font-weight:500;
    color:var(--text-bright);animation:toastIn .3s ease;
    box-shadow:0 4px 20px rgba(0,0,0,0.4);max-width:360px;
  }
  .toast-success{background:rgba(0,212,170,0.9)}
  .toast-error{background:rgba(249,65,68,0.9)}
  .toast-info{background:rgba(15,52,96,0.95);border:1px solid var(--border)}
  @keyframes toastIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
  .toast-exit{animation:toastOut .3s ease forwards}
  @keyframes toastOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}

  /* Request Flow */
  .flow-card{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
    padding:24px;margin-bottom:32px;
  }
  .flow-card .section-title{margin-bottom:16px}
  .flow-empty{
    display:flex;align-items:center;justify-content:center;
    color:var(--text-dim);font-size:14px;padding:32px 20px;
  }
  .flow-pipeline{
    display:flex;align-items:flex-start;gap:0;overflow-x:auto;padding-bottom:8px;
  }
  .flow-arrow{
    display:flex;align-items:center;padding-top:28px;
    color:var(--text-dim);font-size:18px;flex-shrink:0;
    min-width:36px;justify-content:center;
    user-select:none;
  }
  .flow-step{
    flex:1;min-width:200px;max-width:280px;background:rgba(0,0,0,0.2);
    border:1px solid var(--border);border-radius:10px;
    padding:16px;position:relative;transition:border-color .3s ease;
  }
  .flow-step:hover{border-color:#3a5a8a}
  .flow-step-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
  .flow-step-number{
    width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-size:14px;font-weight:700;color:#fff;flex-shrink:0;
  }
  .flow-step-number.dir-inbound{background:#4361ee}
  .flow-step-number.dir-internal{background:#7b2ff7}
  .flow-step-number.dir-outbound{background:var(--orange)}
  .flow-step-number.dir-response-ok{background:var(--green)}
  .flow-step-number.dir-response-fail{background:var(--red)}
  .flow-step-label{font-size:14px;font-weight:700;color:var(--text-bright)}
  .flow-step-duration{
    font-size:11px;color:var(--text-dim);margin-left:auto;
    background:rgba(0,0,0,0.3);padding:2px 8px;border-radius:6px;white-space:nowrap;
  }
  .flow-step-body{font-size:12px;color:var(--text);line-height:1.6}
  .flow-step-body .flow-kv{display:flex;gap:6px;margin-bottom:2px}
  .flow-kv-key{color:var(--text-dim);min-width:70px;flex-shrink:0;font-weight:500}
  .flow-kv-val{color:var(--text-bright);font-weight:500;word-break:break-all}

  /* Step 2 - Routing evaluations */
  .flow-eval-table{width:100%;font-size:11px;border-collapse:collapse;margin-top:6px}
  .flow-eval-table th{
    text-align:left;padding:4px 6px;font-weight:600;color:var(--text-dim);
    border-bottom:1px solid var(--border);font-size:10px;text-transform:uppercase;letter-spacing:.3px;
  }
  .flow-eval-table td{padding:4px 6px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .flow-eval-table tr.eval-selected{background:rgba(0,212,170,0.08)}
  .flow-eval-table tr.eval-ineligible{opacity:.55}
  .eval-icon{font-size:13px;margin-right:2px}
  .eval-eligible{color:var(--green)}
  .eval-ineligible-icon{color:var(--red)}
  .eval-geo{
    display:inline-block;font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;
    background:rgba(0,212,170,0.12);color:var(--green);
  }
  .eval-skip{font-size:10px;color:var(--red);font-style:italic}
  .eval-proc-name{font-weight:600;color:var(--text-bright)}
  .eval-selected-badge{
    font-size:9px;font-weight:700;padding:1px 6px;border-radius:4px;margin-left:4px;
    background:rgba(0,212,170,0.18);color:var(--green);text-transform:uppercase;
  }
  .flow-sort-order{
    font-size:11px;color:var(--text-dim);margin-top:8px;padding-top:6px;
    border-top:1px solid var(--border);font-style:italic;
  }

  @media(max-width:900px){
    .flow-pipeline{flex-direction:column;align-items:stretch}
    .flow-step{max-width:100%;min-width:auto}
    .flow-arrow{padding-top:0;min-width:auto;min-height:24px;transform:rotate(90deg)}
  }
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="header-logo">Z</div>
    <div>
      <h1>Zenith Gaming &mdash; Payment Router Dashboard</h1>
      <p>Smart routing with automatic failover</p>
    </div>
  </div>
  <div class="header-status">
    <div class="pulse"></div>
    <span id="header-status-text">Connecting...</span>
  </div>
</div>

<div class="container">

  <!-- Processors -->
  <div class="section-title" style="margin-top:8px">Processor Health</div>
  <div class="processors-grid" id="processors-grid">
    <div class="proc-card" style="display:flex;align-items:center;justify-content:center;min-height:220px;color:var(--text-dim)">Loading processors...</div>
  </div>

  <!-- Payment Form + Response -->
  <div class="bottom-grid">
    <div class="form-card">
      <div class="section-title">Send Payment</div>
      <div class="form-group">
        <label>Amount (minor units)</label>
        <input type="number" id="pay-amount" value="1500" min="1">
      </div>
      <div class="form-group">
        <label>Currency</label>
        <select id="pay-currency">
          <option value="BRL">BRL - Brazilian Real</option>
          <option value="MXN">MXN - Mexican Peso</option>
          <option value="COP">COP - Colombian Peso</option>
          <option value="CLP">CLP - Chilean Peso</option>
        </select>
      </div>
      <div class="form-group">
        <label>Country</label>
        <select id="pay-country">
          <option value="BR">BR - Brazil</option>
          <option value="MX">MX - Mexico</option>
          <option value="CO">CO - Colombia</option>
          <option value="CL">CL - Chile</option>
        </select>
      </div>
      <div class="form-group">
        <label>Payment Method</label>
        <select id="pay-method">
          <option value="CREDIT_CARD">CREDIT_CARD</option>
          <option value="DEBIT_CARD">DEBIT_CARD</option>
          <option value="PIX">PIX</option>
          <option value="OXXO">OXXO</option>
          <option value="PSE">PSE</option>
          <option value="WALLET">WALLET</option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn-primary" id="btn-send" onclick="sendPayment()">Send Payment</button>
        <button class="btn-secondary" id="btn-burst" onclick="sendBurst()">Send 10x Burst</button>
      </div>
      <div class="burst-progress" id="burst-progress" style="display:none">
        <span id="burst-text">Sending 0/10...</span>
        <div class="burst-bar"><div class="burst-bar-fill" id="burst-bar-fill"></div></div>
      </div>
    </div>
    <div class="response-card">
      <div class="section-title">Last Response</div>
      <div id="response-content">
        <div class="response-empty">Send a payment to see the routing response</div>
      </div>
    </div>
  </div>

  <!-- Request Flow -->
  <div class="flow-card">
    <div class="section-title">Request Flow</div>
    <div id="flow-content">
      <div class="flow-empty">Send a payment to see the request flow</div>
    </div>
  </div>

  <!-- Transaction Log -->
  <div class="txn-card">
    <div class="txn-header">
      <div class="section-title" style="margin-bottom:0">Transaction Log</div>
      <div class="txn-count" id="txn-count">0 transactions</div>
    </div>
    <div class="txn-table-wrap" style="max-height:480px;overflow-y:auto">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Transaction ID</th>
            <th>Processor</th>
            <th>Status</th>
            <th>Amount</th>
            <th>Country</th>
            <th>Routing Reason</th>
            <th>Latency</th>
          </tr>
        </thead>
        <tbody id="txn-tbody">
          <tr><td colspan="8" class="empty-table">No transactions yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<div class="toast-container" id="toast-container"></div>

<script>
  const API = window.location.origin;
  let knownTxnIds = new Set();
  let firstLoad = true;

  // ---- Utility ----
  function formatTime(iso) {
    if (!iso) return '-';
    const d = new Date(iso);
    return d.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function formatAmount(amount, currency) {
    const divisor = (currency === 'CLP' || currency === 'COP') ? 1 : 100;
    const val = (amount / divisor).toFixed(divisor === 1 ? 0 : 2);
    return `${currency} ${val}`;
  }

  function pctDisplay(rate) {
    if (rate === undefined || rate === null) return '-';
    return (rate * 100).toFixed(1) + '%';
  }

  function processorDisplayName(id) {
    const map = {
      'processor-a': 'Processor A',
      'processor-b': 'Processor B',
      'processor-c': 'Processor C',
    };
    return map[id] || id;
  }

  function statusBadgeClass(status) {
    if (status === 'HEALTHY') return 'badge-healthy';
    if (status === 'DEGRADED') return 'badge-degraded';
    return 'badge-down';
  }

  function circuitBadgeClass(state) {
    if (state === 'open') return 'open';
    if (state === 'half-open') return 'half-open';
    return '';
  }

  function txnStatusClass(status) {
    if (status === 'APPROVED') return 'txn-approved';
    if (status === 'DECLINED') return 'txn-declined';
    return 'txn-error';
  }

  function respStatusClass(status) {
    if (status === 'APPROVED') return 'resp-approved';
    if (status === 'DECLINED') return 'resp-declined';
    return 'resp-error';
  }

  function reasonLabel(reason) {
    const map = {
      'primary_healthy': 'Primary healthy',
      'geo_match_preferred': 'Geo match preferred',
      'fallback_primary_unhealthy': 'Fallback (primary down)',
      'fallback_circuit_open': 'Fallback (circuit open)',
      'cost_optimized': 'Cost optimized',
      'lowest_cost': 'Lowest cost',
      'geo_fallback': 'Geo fallback',
    };
    return map[reason] || reason || '-';
  }

  // ---- Toast ----
  function showToast(message, type) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type || 'info'}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('toast-exit');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  // ---- API calls ----
  async function fetchJSON(url, opts) {
    const res = await fetch(url, opts);
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status}: ${text}`);
    }
    return res.json();
  }

  // ---- Processors ----
  async function loadProcessors() {
    try {
      const processors = await fetchJSON(`${API}/v1/processors`);
      renderProcessors(processors);
      document.getElementById('header-status-text').textContent = `Live — ${processors.length} processors`;
    } catch (e) {
      document.getElementById('header-status-text').textContent = 'Connection error';
      if (firstLoad) {
        document.getElementById('processors-grid').innerHTML =
          '<div class="proc-card" style="grid-column:1/-1;text-align:center;padding:40px;color:var(--red)">Could not connect to server. Make sure the Go backend is running.</div>';
      }
    }
    firstLoad = false;
  }

  function renderProcessors(processors) {
    const grid = document.getElementById('processors-grid');
    grid.innerHTML = '';
    processors.forEach(p => {
      const simActive = p.simulation && p.simulation.active;
      const card = document.createElement('div');
      card.className = 'proc-card';
      card.dataset.status = p.status;
      card.innerHTML = `
        <div class="proc-header">
          <span class="proc-name">${processorDisplayName(p.id)}</span>
          <div class="proc-badges">
            <span class="badge ${statusBadgeClass(p.status)}">${p.status}</span>
            <span class="badge badge-circuit ${circuitBadgeClass(p.circuit_state)}">${p.circuit_state}</span>
          </div>
        </div>
        <div class="proc-metrics">
          <div class="metric">
            <div class="metric-value">${pctDisplay(p.approval_rate)}</div>
            <div class="metric-label">Approval Rate</div>
          </div>
          <div class="metric">
            <div class="metric-value">${p.total_txns || 0}</div>
            <div class="metric-label">Total Txns</div>
          </div>
          <div class="metric">
            <div class="metric-value">${p.avg_latency_ms || 0}<small style="font-size:11px;color:var(--text-dim)">ms</small></div>
            <div class="metric-label">Avg Latency</div>
          </div>
        </div>
        <div class="proc-config">
          <span class="config-tag">Priority: ${p.priority}</span>
          <span class="config-tag">$${p.cost_per_txn}/txn</span>
          ${(p.geo_preferences || []).map(g => `<span class="config-tag geo-tag">${g}</span>`).join('')}
        </div>
        <div class="proc-stats">
          <div class="stat stat-approved">
            <div class="stat-value">${p.total_approved || 0}</div>
            <div class="stat-label">Approved</div>
          </div>
          <div class="stat stat-declined">
            <div class="stat-value">${p.total_declined || 0}</div>
            <div class="stat-label">Declined</div>
          </div>
          <div class="stat stat-errors">
            <div class="stat-value">${p.total_errors || 0}</div>
            <div class="stat-label">Errors</div>
          </div>
        </div>
        <div class="proc-sim">
          <div class="sim-label">Simulation Controls${simActive ? ' <span class="sim-active-indicator">ACTIVE</span>' : ''}</div>
          <div class="sim-row">
            <select class="sim-select" id="sim-select-${p.id}" onchange="applySimulation('${p.id}', this.value)">
              <option value="normal" ${!simActive ? 'selected' : ''}>Normal</option>
              <option value="50fail" ${simActive && p.simulation.failure_rate === 0.5 && !p.simulation.force_error ? 'selected' : ''}>50% Failures</option>
              <option value="100fail" ${simActive && p.simulation.failure_rate === 1.0 && !p.simulation.force_error ? 'selected' : ''}>100% Failures</option>
              <option value="force_error" ${simActive && p.simulation.force_error ? 'selected' : ''}>Force Error</option>
            </select>
            <button class="btn-sm btn-down" onclick="forceStatus('${p.id}','DOWN')">Force DOWN</button>
            <button class="btn-sm btn-up" onclick="forceStatus('${p.id}','HEALTHY')">Force HEALTHY</button>
            <button class="btn-sm btn-reset" onclick="resetProcessor('${p.id}')">Reset</button>
          </div>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  async function applySimulation(procId, value) {
    let body;
    switch (value) {
      case 'normal':
        body = { failure_rate: 0, force_error: false, active: false };
        break;
      case '50fail':
        body = { failure_rate: 0.5, force_error: false, active: true };
        break;
      case '100fail':
        body = { failure_rate: 1.0, force_error: false, active: true };
        break;
      case 'force_error':
        body = { failure_rate: 0, force_error: true, active: true };
        break;
      default:
        return;
    }
    try {
      await fetchJSON(`${API}/v1/admin/processors/${procId}/simulate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      showToast(`Simulation updated for ${processorDisplayName(procId)}`, 'success');
      loadProcessors();
    } catch (e) {
      showToast(`Error: ${e.message}`, 'error');
    }
  }

  async function forceStatus(procId, status) {
    try {
      await fetchJSON(`${API}/v1/admin/processors/${procId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: status, reason: 'Manual override from dashboard' }),
      });
      showToast(`${processorDisplayName(procId)} set to ${status}`, status === 'DOWN' ? 'error' : 'success');
      loadProcessors();
    } catch (e) {
      showToast(`Error: ${e.message}`, 'error');
    }
  }

  async function resetProcessor(procId) {
    try {
      await fetchJSON(`${API}/v1/admin/processors/${procId}/simulate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ failure_rate: 0, force_error: false, active: false }),
      });
      await fetchJSON(`${API}/v1/admin/processors/${procId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'HEALTHY', reason: 'Reset from dashboard' }),
      });
      showToast(`${processorDisplayName(procId)} reset to normal`, 'info');
      loadProcessors();
    } catch (e) {
      showToast(`Error: ${e.message}`, 'error');
    }
  }

  // ---- Payment ----
  async function sendPayment() {
    const btn = document.getElementById('btn-send');
    btn.disabled = true;
    btn.textContent = 'Sending...';
    try {
      const payload = {
        amount: parseInt(document.getElementById('pay-amount').value) || 1500,
        currency: document.getElementById('pay-currency').value,
        payment_method: document.getElementById('pay-method').value,
        country: document.getElementById('pay-country').value,
        customer_id: 'cust_demo',
        description: 'In-game purchase',
      };
      const resp = await fetchJSON(`${API}/v1/payments/authorize`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      renderResponse(resp);
      loadTransactions();
      loadProcessors();
    } catch (e) {
      showToast(`Payment error: ${e.message}`, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Send Payment';
    }
  }

  async function sendBurst() {
    const btn = document.getElementById('btn-burst');
    const btnSend = document.getElementById('btn-send');
    const prog = document.getElementById('burst-progress');
    const progText = document.getElementById('burst-text');
    const progBar = document.getElementById('burst-bar-fill');

    btn.disabled = true;
    btnSend.disabled = true;
    prog.style.display = 'block';

    const payload = {
      amount: parseInt(document.getElementById('pay-amount').value) || 1500,
      currency: document.getElementById('pay-currency').value,
      payment_method: document.getElementById('pay-method').value,
      country: document.getElementById('pay-country').value,
      customer_id: 'cust_demo',
      description: 'In-game purchase (burst)',
    };

    let completed = 0;
    for (let i = 0; i < 10; i++) {
      try {
        const resp = await fetchJSON(`${API}/v1/payments/authorize`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        renderResponse(resp);
      } catch (e) {
        // continue burst even on error
      }
      completed++;
      progText.textContent = `Sending ${completed}/10...`;
      progBar.style.width = `${completed * 10}%`;
      if (i < 9) await new Promise(r => setTimeout(r, 200));
    }

    progText.textContent = 'Burst complete!';
    showToast('10x burst complete', 'success');
    loadTransactions();
    loadProcessors();

    setTimeout(() => {
      prog.style.display = 'none';
      progBar.style.width = '0';
    }, 2000);

    btn.disabled = false;
    btnSend.disabled = false;
  }

  function renderResponse(resp) {
    const el = document.getElementById('response-content');
    const rd = resp.routing_decision || {};
    el.innerHTML = `
      <div class="resp-status-row">
        <span class="resp-status-badge ${respStatusClass(resp.status)}">${resp.status}</span>
        <span class="resp-processor">${processorDisplayName(resp.processor_used)}</span>
      </div>
      <div class="resp-details">
        <div class="resp-detail">
          <div class="resp-detail-label">Transaction ID</div>
          <div class="resp-detail-value" style="font-family:monospace;font-size:12px">${resp.transaction_id || '-'}</div>
        </div>
        <div class="resp-detail">
          <div class="resp-detail-label">Routing Reason</div>
          <div class="resp-detail-value">${reasonLabel(rd.reason)}</div>
        </div>
        <div class="resp-detail">
          <div class="resp-detail-label">Fallback Used</div>
          <div class="resp-detail-value">${rd.fallback_used ? 'Yes' : 'No'}</div>
        </div>
        <div class="resp-detail">
          <div class="resp-detail-label">Geo Match</div>
          <div class="resp-detail-value">${rd.geo_match !== undefined ? (rd.geo_match ? 'Yes' : 'No') : '-'}</div>
        </div>
        <div class="resp-detail">
          <div class="resp-detail-label">Cost</div>
          <div class="resp-detail-value">$${rd.cost_basis_usd !== undefined ? rd.cost_basis_usd.toFixed(2) : '-'} USD</div>
        </div>
        <div class="resp-detail">
          <div class="resp-detail-label">Processors Evaluated</div>
          <div class="resp-detail-value">${(rd.processors_evaluated || []).map(processorDisplayName).join(', ') || '-'}</div>
        </div>
        <div class="resp-detail" style="grid-column:1/-1">
          <div class="resp-detail-label">Amount</div>
          <div class="resp-detail-value">${formatAmount(resp.amount, resp.currency)}</div>
        </div>
      </div>
    `;
    // Render flow visualization if flow data is present
    if (resp.flow && resp.flow.length > 0) {
      renderFlow(resp.flow, resp.status);
    }
  }

  // ---- Request Flow ----
  function flowStepNumberClass(direction, status) {
    if (direction === 'inbound') return 'dir-inbound';
    if (direction === 'internal') return 'dir-internal';
    if (direction === 'outbound') return 'dir-outbound';
    if (direction === 'response') {
      return (status === 'APPROVED') ? 'dir-response-ok' : 'dir-response-fail';
    }
    return 'dir-inbound';
  }

  function renderFlowKV(key, value) {
    return `<div class="flow-kv"><span class="flow-kv-key">${key}</span><span class="flow-kv-val">${value}</span></div>`;
  }

  function renderRoutingEvaluations(data) {
    const evals = data.evaluations || [];
    if (evals.length === 0) return '';
    let html = `<table class="flow-eval-table">
      <thead><tr><th>Processor</th><th>Status</th><th>Circuit</th><th>Geo</th><th>Cost</th><th>Eligible</th></tr></thead><tbody>`;
    evals.forEach(ev => {
      const isSelected = ev.processor_id === data.selected_processor;
      const rowClass = isSelected ? 'eval-selected' : (!ev.eligible ? 'eval-ineligible' : '');
      const eligibleIcon = ev.eligible
        ? `<span class="eval-icon eval-eligible">&#10003;</span>`
        : `<span class="eval-icon eval-ineligible-icon">&#10007;</span>`;
      const geoTag = ev.geo_match ? `<span class="eval-geo">GEO</span>` : '-';
      const procLabel = `<span class="eval-proc-name">${processorDisplayName(ev.processor_id)}</span>${isSelected ? '<span class="eval-selected-badge">selected</span>' : ''}`;
      const skipInfo = (!ev.eligible && ev.skip_reason) ? `<br><span class="eval-skip">${ev.skip_reason}</span>` : '';
      html += `<tr class="${rowClass}">
        <td>${procLabel}</td>
        <td><span class="badge ${statusBadgeClass(ev.status)}" style="font-size:9px;padding:1px 6px">${ev.status}</span></td>
        <td><span class="badge badge-circuit ${circuitBadgeClass(ev.circuit_state)}" style="font-size:9px;padding:1px 6px">${ev.circuit_state}</span></td>
        <td>${geoTag}</td>
        <td>$${ev.cost_per_txn}</td>
        <td>${eligibleIcon}${skipInfo}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    if (data.sort_order) {
      html += `<div class="flow-sort-order">Sort: ${data.sort_order}</div>`;
    }
    return html;
  }

  function renderStepBody(step, overallStatus) {
    const d = step.data || {};

    // Step 2: Routing Evaluation — special rendering
    if (step.step === 2 && d.evaluations) {
      return renderRoutingEvaluations(d);
    }

    // Generic key-value rendering for other steps
    let html = '';
    const skipKeys = new Set(['evaluations', 'selected_processor', 'sort_order']);
    Object.keys(d).forEach(key => {
      if (skipKeys.has(key)) return;
      let val = d[key];
      if (typeof val === 'object') val = JSON.stringify(val);
      html += renderFlowKV(key, val);
    });
    return `<div class="flow-step-body">${html}</div>`;
  }

  function renderFlow(flow, overallStatus) {
    const container = document.getElementById('flow-content');
    if (!flow || flow.length === 0) {
      container.innerHTML = '<div class="flow-empty">No flow data available for this payment</div>';
      return;
    }

    let html = '<div class="flow-pipeline">';
    flow.forEach((step, idx) => {
      // Arrow between steps
      if (idx > 0) {
        html += '<div class="flow-arrow">&rarr;</div>';
      }

      const numClass = flowStepNumberClass(step.direction, overallStatus);
      const durationBadge = step.duration_ms !== undefined
        ? `<span class="flow-step-duration">${step.duration_ms}ms</span>`
        : '';

      html += `
        <div class="flow-step">
          <div class="flow-step-header">
            <div class="flow-step-number ${numClass}">${step.step}</div>
            <span class="flow-step-label">${step.label}</span>
            ${durationBadge}
          </div>
          ${renderStepBody(step, overallStatus)}
        </div>`;
    });
    html += '</div>';
    container.innerHTML = html;
  }

  // ---- Transactions ----
  async function loadTransactions() {
    try {
      const txns = await fetchJSON(`${API}/v1/transactions?limit=50`);
      renderTransactions(txns || []);
    } catch (e) {
      // silent - will retry on next interval
    }
  }

  function renderTransactions(txns) {
    const tbody = document.getElementById('txn-tbody');
    const countEl = document.getElementById('txn-count');
    countEl.textContent = `${txns.length} transaction${txns.length !== 1 ? 's' : ''}`;

    if (txns.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="empty-table">No transactions yet. Send a payment to get started.</td></tr>';
      return;
    }

    const newIds = new Set();
    tbody.innerHTML = '';
    txns.forEach(t => {
      const isNew = !knownTxnIds.has(t.id);
      newIds.add(t.id);
      const tr = document.createElement('tr');
      if (isNew && !firstLoad) tr.className = 'new-row';
      tr.innerHTML = `
        <td>${formatTime(t.created_at)}</td>
        <td class="txn-id">${t.id || '-'}</td>
        <td class="txn-processor">${processorDisplayName(t.processor_used)}</td>
        <td><span class="txn-status ${txnStatusClass(t.status)}">${t.status}</span></td>
        <td class="txn-amount">${formatAmount(t.amount, t.currency)}</td>
        <td><span class="txn-country">${t.country || '-'}</span></td>
        <td class="txn-reason">${reasonLabel(t.routing_reason)}</td>
        <td class="txn-latency">${t.latency_ms || 0}ms</td>
      `;
      tbody.appendChild(tr);
    });
    knownTxnIds = newIds;
  }

  // ---- Currency/Country sync ----
  document.getElementById('pay-currency').addEventListener('change', function() {
    const map = { BRL: 'BR', MXN: 'MX', COP: 'CO', CLP: 'CL' };
    const country = map[this.value];
    if (country) document.getElementById('pay-country').value = country;
  });

  document.getElementById('pay-country').addEventListener('change', function() {
    const map = { BR: 'BRL', MX: 'MXN', CO: 'COP', CL: 'CLP' };
    const currency = map[this.value];
    if (currency) document.getElementById('pay-currency').value = currency;
  });

  // ---- Init ----
  loadProcessors();
  loadTransactions();
  setInterval(loadProcessors, 2000);
  setInterval(loadTransactions, 2000);
</script>
</body>
</html>
